stages:
  - lint
  - build
  - publish

pre-commit:
    stage: lint
    rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    image: python:3.11
    before_script:
        - pip install pre-commit==3.6.0
    script:
        - pre-commit run -v --all-files

build (linux):
    stage: build
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"
        - if: $CI_COMMIT_TAG
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
          changes:
          - "chars/*"
          - "cli/*"
          - "common/*"
          - "include/*"
          - "lib/*"
    image: python:3.8-slim-bookworm
    before_script:
        - apt-get update -y
        - apt-get install -y cmake pkg-config gcc libusb-1.0-0-dev libsdl2-dev
        - pip install toml
    script:
        - cmake -B build -S . -DCMAKE_INSTALL_PREFIX=/usr
        - cmake --build build

build (i686-w64-mingw32):
    stage: build
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"
        - if: $CI_COMMIT_TAG
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
          changes:
          - "chars/*"
          - "cli/*"
          - "common/*"
          - "include/*"
          - "lib/*"
    image: registry.gitlab.com/cahuteproject/docker-images/mingw-w64:latest
    script:
        - i686-w64-mingw32-cmake -B build -S .
        - cmake --build build

build (x86_64-w64-mingw32):
    stage: build
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"
        - if: $CI_COMMIT_TAG
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
          changes:
          - "chars/*"
          - "cli/*"
          - "common/*"
          - "include/*"
          - "lib/*"
    image: registry.gitlab.com/cahuteproject/docker-images/mingw-w64:latest
    script:
        - x86_64-w64-mingw32-cmake -B build -S .
        - cmake --build build

build (m68k-amigaos):
    stage: build
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"
        - if: $CI_COMMIT_TAG
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
          changes:
          - "chars/*"
          - "cli/*"
          - "common/*"
          - "include/*"
          - "lib/*"
    image: amigadev/crosstools:m68k-amigaos
    before_script:
        - apt-get update -y && apt-get install -y python3 python3-toml
    script:
        - cmake -B build -S .
        - cmake --build build

build tarball:
    stage: build
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"
        - if: $CI_COMMIT_TAG
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
          changes:
          - "chars/*"
          - "cli/*"
          - "common/*"
          - "include/*"
          - "lib/*"
    image: debian:bookworm-slim
    before_script:
        - apt-get update -y
        - apt-get install -y cmake pkg-config gcc libusb-1.0-0-dev libsdl2-dev
    script:
        - cmake -B build -S .
        - cpack --config build/CPackSourceConfig.cmake
    artifacts:
        paths:
            - cahute-*.tar.gz

build docs:
    stage: build
    rules:
        - if: $CI_COMMIT_BRANCH == "develop"
        - if: $CI_COMMIT_TAG
        - if: $CI_PIPELINE_SOURCE == "merge_request_event"
          changes:
          - "docs/*"
    image: python:3.11
    before_script:
        - pip install -r docs/requirements.txt
    script:
        - sphinx-build -M html docs docs/_build
    artifacts:
        paths:
            - docs/_build/html

publish docs:
    stage: publish
    rules:
      - if: $CI_COMMIT_TAG
        when: always
        variables:
            UPLOAD_PATH: /var/www/cahuteproject/www
      - if: $CI_COMMIT_BRANCH == "develop"
        when: always
        variables:
            UPLOAD_PATH: /var/www/cahuteproject/next
    image: debian:bookworm-slim
    before_script:
        - apt-get update -y
        - apt-get install -y rsync openssh-client
        - eval $(ssh-agent -s)
        - mkdir ~/.ssh && chmod 700 ~/.ssh
        - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" >~/.ssh/config
        - chmod 400 "$SSH_PRIVATE_KEY"
        - ssh-add "$SSH_PRIVATE_KEY"
    script:
        - rsync -Prlt --delete docs/_build/html/ gitlab-cahute@cahuteproject.org:$UPLOAD_PATH
    dependencies:
        - build docs

publish tarball:
    stage: publish
    rules:
        - if: $CI_COMMIT_TAG
          when: always
    image: debian:bookworm-slim
    before_script:
        - apt-get update -y
        - apt-get install -y openssh-client
        - eval $(ssh-agent -s)
        - mkdir ~/.ssh && chmod 700 ~/.ssh
        - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" >~/.ssh/config
        - chmod 400 "$SSH_PRIVATE_KEY"
        - ssh-add "$SSH_PRIVATE_KEY"
    script:
        - export RELEASE_FILE=$(ls cahute-*.tar.gz)
        - sha256sum $RELEASE_FILE >$RELEASE_FILE.sha256
        - b2sum $RELEASE_FILE >$RELEASE_FILE.b2
        - scp $RELEASE_FILE $RELEASE_FILE.sha256 $RELEASE_FILE.b2 gitlab-cahute@cahuteproject.org:/var/www/cahuteproject/ftp/releases
    dependencies:
        - build tarball
